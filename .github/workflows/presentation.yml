name: Presentation

permissions:
    contents: read
    deployments: write
    packages: write

on:
    push:
        branches:
            - 'main'
        paths:
            - 'presentation/**'
            - '.github/workflows/presentation.yml'
    pull_request:
        paths:
            - 'presentation/**'
            - '.github/workflows/presentation.yml'

jobs:
    lint:
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Setup Node.js
                uses: actions/setup-node@v4
                with:
                    node-version: '24'
                    cache: 'npm'
                    cache-dependency-path: presentation/package-lock.json

            -   name: Install dependencies
                run: npm ci
                working-directory: presentation

            -   name: Run lint
                run: npm run lint
                working-directory: presentation

    docker-image:
        runs-on: ubuntu-latest
        needs:
            - lint
        if: github.event_name != 'pull_request'
        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Docker meta
                id: meta
                uses: docker/metadata-action@v5
                with:
                    images: |
                        ghcr.io/janmikes/fotbal-fm.cz-presentation
                    tags: |
                        type=ref,event=branch
                        type=ref,event=pr

            -   name: Set up Docker Buildx
                uses: docker/setup-buildx-action@v3

            -   name: Login to GHCR
                uses: docker/login-action@v3
                with:
                    registry: ghcr.io
                    username: ${{ github.repository_owner }}
                    password: ${{ secrets.GITHUB_TOKEN }}

            -   name: Build and push Presentation
                uses: docker/build-push-action@v5
                with:
                    context: ./presentation
                    push: true
                    tags: ${{ steps.meta.outputs.tags }}
                    labels: ${{ steps.meta.outputs.labels }}
                    cache-from: type=gha, scope=${{ github.workflow }}
                    cache-to: type=gha, scope=${{ github.workflow }}

    deploy:
        runs-on: ubuntu-latest
        needs:
            - docker-image
        steps:
            - name: executing remote ssh commands using ssh key
              uses: appleboy/ssh-action@master
              with:
                host: fotbal-fm.thedevs.cz
                username: ${{ secrets.DEPLOY_USERNAME }}
                key: ${{ secrets.DEPLOY_PRIVATE_KEY }}
                script: cd /deployment/fotbal-fm-web && ./deploy-presentation.sh
